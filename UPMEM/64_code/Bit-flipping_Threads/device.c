#include <stdio.h>
#include <stdlib.h>
#include <mram.h>
#include <perfcounter.h>
#include <limits.h>
#include <defs.h>
#include <barrier.h>

#include "types_min_sum.h"

#define N 128
#define M 64
#define EDGES 512

#define CN_PER_THREADS M/NR_TASKLETS
#define VN_PER_THREADS N/NR_TASKLETS

BARRIER_INIT(my_barrier, NR_TASKLETS);

__dma_aligned unsigned char LUT_VN[EDGES]={0,9,26,44,48,1,10,27,45,49,2,11,28,46,50,3,12,29,47,51,4,13,30,32,52,5,14,31,33,53,6,15,16,34,54,0,7,17,35,55,1,8,18,36,56,2,9,19,37,57,3,10,20,38,58,4,11,21,39,59,5,12,22,40,60,6,13,23,41,61,7,14,24,42,62,8,15,25,43,63,14,16,17,47,63,15,17,18,32,48,0,18,19,33,49,1,19,20,34,50,2,20,21,35,51,3,21,22,36,52,4,22,23,37,53,5,23,24,38,54,6,24,25,39,55,7,25,26,40,56,8,26,27,41,57,9,27,28,42,58,10,28,29,43,59,11,29,30,44,60,12,30,31,45,61,13,16,31,46,62,2,16,32,33,55,3,17,33,34,56,4,18,34,35,57,5,19,35,36,58,6,20,36,37,59,7,21,37,38,60,8,22,38,39,61,9,23,39,40,62,10,24,40,41,63,11,25,41,42,48,12,26,42,43,49,13,27,43,44,50,14,28,44,45,51,15,29,45,46,52,0,30,46,47,53,1,31,32,47,54,10,31,34,48,51,11,16,35,49,52,12,17,36,50,53,13,18,37,51,54,14,19,38,52,55,15,20,39,53,56,0,21,40,54,57,1,22,41,55,58,2,23,42,56,59,3,24,43,57,60,4,25,44,58,61,5,26,45,59,62,6,27,46,60,63,7,28,47,48,61,8,29,32,49,62,9,30,33,50,63,16,37,50,17,38,51,18,39,52,19,40,53,20,41,54,21,42,55,22,43,56,23,44,57,24,45,58,25,46,59,26,47,60,27,32,61,28,33,62,29,34,63,30,35,48,31,36,49,0,32,63,1,33,48,2,34,49,3,35,50,4,36,51,5,37,52,6,38,53,7,39,54,8,40,55,9,41,56,10,42,57,11,43,58,12,44,59,13,45,60,14,46,61,15,47,62,3,16,48,4,17,49,5,18,50,6,19,51,7,20,52,8,21,53,9,22,54,10,23,55,11,24,56,12,25,57,13,26,58,14,27,59,15,28,60,0,29,61,1,30,62,2,31,63,0,25,45,1,26,46,2,27,47,3,28,32,4,29,33,5,30,34,6,31,35,7,16,36,8,17,37,9,18,38,10,19,39,11,20,40,12,21,41,13,22,42,14,23,43,15,24,44};
__dma_aligned unsigned char LUT_CN[EDGES]={0,7,18,46,54,80,109,112,1,8,19,47,55,81,110,113,2,9,20,32,56,82,111,114,3,10,21,33,57,83,96,115,4,11,22,34,58,84,97,116,5,12,23,35,59,85,98,117,6,13,24,36,60,86,99,118,7,14,25,37,61,87,100,119,8,15,26,38,62,88,101,120,0,9,27,39,63,89,102,121,1,10,28,40,48,90,103,122,2,11,29,41,49,91,104,123,3,12,30,42,50,92,105,124,4,13,31,43,51,93,106,125,5,14,16,44,52,94,107,126,6,15,17,45,53,95,108,127,6,16,31,32,49,64,96,119,7,16,17,33,50,65,97,120,8,17,18,34,51,66,98,121,9,18,19,35,52,67,99,122,10,19,20,36,53,68,100,123,11,20,21,37,54,69,101,124,12,21,22,38,55,70,102,125,13,22,23,39,56,71,103,126,14,23,24,40,57,72,104,127,15,24,25,41,58,73,105,112,0,25,26,42,59,74,106,113,1,26,27,43,60,75,107,114,2,27,28,44,61,76,108,115,3,28,29,45,62,77,109,116,4,29,30,46,63,78,110,117,5,30,31,47,48,79,111,118,4,17,32,47,62,75,80,115,5,18,32,33,63,76,81,116,6,19,33,34,48,77,82,117,7,20,34,35,49,78,83,118,8,21,35,36,50,79,84,119,9,22,36,37,51,64,85,120,10,23,37,38,52,65,86,121,11,24,38,39,53,66,87,122,12,25,39,40,54,67,88,123,13,26,40,41,55,68,89,124,14,27,41,42,56,69,90,125,15,28,42,43,57,70,91,126,0,29,43,44,58,71,92,127,1,30,44,45,59,72,93,112,2,31,45,46,60,73,94,113,3,16,46,47,61,74,95,114,0,17,41,48,61,78,81,96,1,18,42,49,62,79,82,97,2,19,43,50,63,64,83,98,3,20,44,48,51,65,84,99,4,21,45,49,52,66,85,100,5,22,46,50,53,67,86,101,6,23,47,51,54,68,87,102,7,24,32,52,55,69,88,103,8,25,33,53,56,70,89,104,9,26,34,54,57,71,90,105,10,27,35,55,58,72,91,106,11,28,36,56,59,73,92,107,12,29,37,57,60,74,93,108,13,30,38,58,61,75,94,109,14,31,39,59,62,76,95,110,15,16,40,60,63,77,80,111};
__dma_aligned short sindrome[M]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
__host char  L[N];
__host uint32_t nb_cycles;
__dma_aligned char wrong_equations[N];




char bar=5;
char teta=0;

int main(){

	perfcounter_config(COUNT_CYCLES, true);

	char max_iter=5;
	char true_codeword=0;
	char num_iter;
	short k;


	for(num_iter=0; num_iter<max_iter;num_iter++){ 
		
		if(me()==0 && teta && bar > 1){

			bar = bar - 1;
		}
	
		barrier_wait(&my_barrier);
		teta=1;
		
		//k=0;
		k=CN_PER_THREADS*me()*8;
		for(int i=CN_PER_THREADS*me(); i<CN_PER_THREADS+(CN_PER_THREADS*me());i++){ 
			short sum=0;
			for(int j=0; j<8;j++){ 
				sum=sum+L[LUT_CN[k+j]];
			}
			sindrome[i]=sum & 0x1;
			k=k+8;
			//printf("sum=%d\n", sum);
			//printf("sindrome[%d]=%d\n", i, sindrome[i]);
		}
		barrier_wait(&my_barrier);

		/* if(me()==0 && num_iter==1){
			for(int i=0; i<M;i++){ 
				printf("%d\n", sindrome[i]);
			}
		}
		barrier_wait(&my_barrier);  */
		

		//k=0;
		k=CN_PER_THREADS*me()*5;
		for(int i=CN_PER_THREADS*me(); i<CN_PER_THREADS+(CN_PER_THREADS*me());i++){ 
			short sum=0;
			for(int j=0; j<5;j++){ 
				sum=sum+sindrome[LUT_VN[k+j]];

			}
			wrong_equations[i]=sum;
			k=k+5;
			
		}
		barrier_wait(&my_barrier);

		k=(M*5)+CN_PER_THREADS*me()*3;
		for(int i=M+(CN_PER_THREADS*me()); i<M+CN_PER_THREADS+(CN_PER_THREADS*me());i++){ 
			short sum=0;
			for(int j=0; j<3;j++){ 
				sum=sum+sindrome[LUT_VN[k+j]];
			}
			wrong_equations[i]=sum;
			k=k+3;
			
		}
		barrier_wait(&my_barrier);

		/* if(me()==0 && num_iter==1){
			for(int i=0; i<N;i++){ 
				printf("%d\n", wrong_equations[i]);
			}
		}
		barrier_wait(&my_barrier);  */

		for(int i=VN_PER_THREADS*me(); i<VN_PER_THREADS+(VN_PER_THREADS*me());i++){ 
			
			if(wrong_equations[i]>=bar){
				if(L[i]==0){
					L[i]=1;
				}
				else{
					L[i]=0;
				}
				teta=false;
				
			}
			//printf("sindrome[%d]=%d\n", i, L[i]);
		}
		barrier_wait(&my_barrier);

		/* if(me()==0 && num_iter==4){
			for(int i=0; i<N;i++){ 
				printf("%d\n", L[i]);
			}
		}
		barrier_wait(&my_barrier); */  
	}

	nb_cycles = perfcounter_get();
	return 1;

}//end MIN_SUM()


